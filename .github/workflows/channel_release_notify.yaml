name: Notify Teams on New Issue

on:
  issues:
    types:
      - closed

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Notify Teams
        run: |
          person_to_message='{"name": "Kumar", "mailId": "kkirtiman@evertz.com"}'
          mention_text="<at>${person_to_message["name"]}</at>"
          
          # Construct the message JSON
          message_json=$(cat << EOF
          {
            "@type": "MessageCard",
            "@context": "https://schema.org/extensions",
            "summary": "Channel Service Release",
            "themeColor": "ff0000",
            "title": "Channel Service Release",
            "sections":[
              {
                "facts":[
                  {"name":"Full Changelog", "value": "https://github.com/kkirtiman-evertz/Qa-Api-Automation-Team--R"},
                  {"name":"QA Check List", "value": ""}
                ]
              }
            ]
          }
          {
            "type": "message",
            "attachments": [
              {
                "contentType": "application/vnd.microsoft.card.adaptive",
                "content": {
                  "type": "AdaptiveCard",
                  "body": [
                  
                    {
                      "type": "TextBlock",
                      "wrap": true,
                      "text": "Hi ${mention_text} team,\n This is a **final test** before moving forward.\n You can start assigning tickets to yourself.\n Thank you!"
                    }
                  ],
                  "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                  "version": "1.0",
                  "msteams": {
                    "width": "Full",
                    "entities": [
                      {
                        "type": "mention",
                        "text": "${mention_text}",
                        "mentioned": {
                          "id": "${person_to_message["mailId"]}",
                          "name": "${person_to_message["name"]}"
                        }
                      }
                    ]
                  }
                }
              }
            ]
          }
          EOF
          )
          
          # Write the message JSON to a file
          echo "$message_json" > message.json
          curl -X POST ${{ secrets.MICROSOFT_TEAMS_ISSUE_NOTIFICATION_URI }} --header 'Content-Type: application/json' -d @message.json
